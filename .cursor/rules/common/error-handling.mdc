---
description: 오류 처리 및 디버깅 가이드라인
globs: **/*.ts, **/*.tsx
alwaysApply: true
---

# 오류 처리 규칙

이 프로젝트에서 오류를 처리할 때는 반드시 [ERRORS.md](mdc:docs/ERRORS.md)를 참조하세요.

## 기본 원칙

- **에러 객체 직렬화**: `console.error`에 에러 객체를 직접 전달하지 말고, 필요한 속성만 추출하여 로깅
- **공개 데이터 접근**: 인증이 필요 없는 공개 데이터는 `createPublicSupabaseClient()` 사용
- **인증 필요 데이터**: 사용자별 데이터는 `createClerkSupabaseClient()` 사용
- **환경변수 검증**: Supabase 클라이언트 생성 전 환경변수 존재 여부 확인

## 에러 처리 패턴

### ✅ 올바른 에러 처리

```typescript
try {
  const supabase = createPublicSupabaseClient();
  const { data, error } = await supabase.from('products').select('*');
  
  if (error) {
    console.error("Error fetching products:", {
      message: error.message,
      details: error.details,
      hint: error.hint,
      code: error.code,
    });
    return defaultValue;
  }
  
  return data;
} catch (error) {
  console.error("Unexpected error:", error);
  return defaultValue;
}
```

### ❌ 잘못된 에러 처리

```typescript
// 에러 객체를 직접 로깅 (빈 객체로 표시될 수 있음)
const { data, error } = await supabase.from('products').select('*');
if (error) {
  console.error("Error:", error); // ❌
  return [];
}

// 환경변수 검증 없이 사용
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!, // ❌
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);
```

## Supabase 클라이언트 선택 가이드

### 공개 데이터 (인증 불필요)
- 상품 목록 조회
- 상품 상세 정보 조회
- 카테고리별 상품 조회

**사용:**
```typescript
import { createClient } from "@supabase/supabase-js";

function createPublicSupabaseClient() {
  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
  const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
  
  if (!supabaseUrl || !supabaseKey) {
    throw new Error("Supabase 환경변수가 설정되지 않았습니다.");
  }
  
  return createClient(supabaseUrl, supabaseKey);
}
```

### 인증 필요 데이터
- 사용자별 장바구니
- 사용자별 주문 내역
- 사용자 프로필

**사용:**
```typescript
import { createClerkSupabaseClient } from "@/lib/supabase/server";

const supabase = createClerkSupabaseClient();
```

## 체크리스트

새로운 기능을 추가하거나 코드를 수정할 때:

- [ ] [ERRORS.md](mdc:docs/ERRORS.md) 문서 확인
- [ ] 적절한 Supabase 클라이언트 타입 선택 (공개 vs 인증)
- [ ] 환경변수 검증 추가
- [ ] 에러 객체를 직렬화하여 로깅
- [ ] try-catch로 예외 처리
- [ ] 기본값 반환 (빈 배열, null 등)

## 참고 문서

- [ERRORS.md](mdc:docs/ERRORS.md) - 상세한 오류 해결 가이드
- [AGENTS.md](mdc:AGENTS.md) - 프로젝트 아키텍처 가이드
